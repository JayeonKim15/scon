<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scon.project.admin.taskBoard.model.dao.TaskBoardMapper">


<resultMap id="taskBoardResultMap" type="com.scon.project.admin.taskBoard.model.dto.TaskBoardDTO">
	<id property="taskId" column="TASK_ID"/>
	<result property="taskTitle" column="TASK_TITLE"/>
	<result property="taskContent" column="TASK_CONTENT"/>
	<result property="taskDate" column="TASK_DATE"/>
	<result property="taskUpdate" column="TASK_UPDATE"/>
	<result property="taskDelete" column="TASK_DELETE"/>
	<result property="taskView" column="TASK_VIEW"/>
	<result property="memberId" column="MEMBER_ID"/>
	<result property="clsId" column="CLS_ID"/>
	<result property="memberName" column="MEMBER_NAME"/>
	
	<collection property="fileList" resultMap="taskFileResultMap"/>
</resultMap>

<resultMap id="fileResultMap" type="com.scon.project.admin.taskBoard.model.dto.FileDTO">
		<id property="fileId" column="FILE_ID"/>
		<result property="fileOrginName" column="FILE_ORGNAME"/>
		<result property="fileSaveName" column="FILE_SAVENAME"/>
		<result property="filePath" column="FILE_PATH"/>
		<result property="fileType" column="FILE_TYPE"/>
</resultMap>

<resultMap id="taskFileResultMap" type="com.scon.project.admin.taskBoard.model.dto.TaskFileDTO">
	<result property="taskId" column="TASK_ID" />
	<result property="fileId" column="FILE_ID"/>
</resultMap>

<!-- class (소영님) 
<resultMap id="classResultMap" type="com.scon.project.admin.Class.dto.ClassDTO">
		<id property="clsId" column="CLS_ID"/>
		<result property="clsName" column="CLS_NAME"/>
		<result property="clsStuNum" column="CLS_STUNUM"/>
		<result property="clsGrade" column="CLS_GRADE"/>
		<result property="clsPay" column="CLS_PAY"/>
		<result property="clsRoom" column="CLS_ROOM"/>
		<result property="clsStart" column="CLS_START"/>
		<result property="clsEnd" column="CLS_END"/>
		<result property="clsNote" column="CLS_NOTE"/>
		<result property="clsStatus" column="CLS_STATUS"/>
</resultMap> -->

<!-- 검색 조건 -->
	<sql id="criteria">
        <trim prefix="AND (" suffix=")" prefixOverrides="OR">
            <foreach collection="typeArr" item="type">
                <trim prefix="OR">
                    <choose>
                        <when test="type == 't'.toString()">
                            CON_HTITLE LIKE '%' || #{ keyword } || '%' 
                        </when>
                        <when test="type == 'c'.toString()">
                            CON_HCONTENT LIKE '%' || #{ keyword } || '%' 
                        </when>
                    </choose>
                </trim>
            </foreach>
        </trim>
    </sql>

	<!--  과제 게시판 목록 조회 -->
		<select id="findAllTask" resultMap="taskBoardResultMap">
			SELECT
				TASK_ID
			  , MEMBER_ID
			  , CLS_ID
			  , TASK_TITLE
			  , TASK_CONTENT
			  , TASK_DATE
			  , TASK_VIEW
			  , MEMBER_NAME
			FROM ( SELECT /*+INDEX_DESC(N PK_TB_TASK)*/
						ROWNUM AS RNUM
			      , T.TASK_ID
				  , T.MEMBER_ID
				  , T.CLS_ID
				  , T.TASK_TITLE
				  , T.TASK_CONTENT
				  , T.TASK_DATE
				  , T.TASK_VIEW
				  , M.MEMBER_NAME
			FROM TB_TASK T
			JOIN TB_MEMBER M ON(T.MEMBER_ID = M.MEMBER_ID)
			WHERE T.CLS_ID = #{ taskBoard.clsId }
			AND T.TASK_DELETE = 'N' 
			<![CDATA[
			          AND ROWNUM <= #{ cri.pageNo } * #{ cri.limit }
					]]>
			  		<if test="taskBoard.keyword != null">
			  		  AND TASK_TITLE LIKE '%' || #{ taskBoard.keyword } || '%'
			  		</if>
			  	  )
		<![CDATA[
			WHERE RNUM > (#{ cri.pageNo } - 1) * #{ cri.limit }
		]]>
		</select>
		
		<!-- 게시물 총 갯수 -->
		<select id="total" resultType="_int">
				SELECT
					   COUNT(*)
				  FROM TB_TASK
				 WHERE TASK_DELETE = 'N'
				 <if test="keyword != null">
				   AND TASK_TITLE LIKE '%' || #{ keyword } || '%'
				 </if>
		</select>


	 <!--  파일 업로드 전 -->
	<!--  <insert id="insert">
	 	INSERT 
	 		INTO TB_TASK
	 		(
	 		 TASK_ID
	       , MEMBER_ID
	       , CLS_ID
	       , TASK_TITLE
	       , TASK_CONTENT
	       , TASK_DATE
	       , TASK_UPDATE
	 		)
	 		VALUES
	 		(
	 		 SEQ_TASK_NO.NEXTVAL
	 	   , 
	 		)
	 </insert>-->

	<!-- 과제 게시판 게시글 입력  -->
 	<insert id="insertTask">
		INSERT
			INTO TB_TASK
			(
				TASK_ID
			  , MEMBER_ID
			  , CLS_ID
			  , TASK_TITLE
			  , TASK_CONTENT
			  , TASK_DATE
			)
			VALUES
			(
				SEQ_TASK_NO.NEXTVAL
			  , #{ memberId }
			  , 1               <!-- , #{ clsId } -->
			  , #{ taskTitle }
			  , #{ taskContent }
			  , SYSDATE
			) 
	</insert> 
	
	
	<insert id="insertFile">
	INSERT
		  INTO TB_FILE
		  (
		   FILE_ID
	 	 , FILE_ORGNAME
		 , FILE_SAVENAME
		 , FILE_PATH
		 , FILE_TYPE
		  )
		 VALUES(
		 	SEQ_FILE_NO.NEXTVAL
		 , #{ fileOrginName }
		 , #{ fileSaveName }
		 , #{ filePath }
		 , #{ fileType }
		 )
	</insert> 
	
	
  	<insert id="insertTaskFileTB">
		INSERT 
		  INTO TB_TASK_FILE
		  (
		  	TASK_ID
		  , FILE_ID
		  )
		  VALUES 
		  (
		    SEQ_TASK_NO.CURRVAL
		  , SEQ_FILE_NO.CURRVAL
		  )
	</insert>
	<!--               -->
	
	<!-- 과제 게시판 게시글 상세 조회 -->
	<select id="findDetail" resultMap="taskBoardResultMap" resultType="list">
  	SELECT *
  	 FROM TB_TASK T
   	JOIN TB_MEMBER M ON (T.MEMBER_ID = M.MEMBER_ID)
    JOIN TB_TASK_FILE TF ON(T.TASK_ID = TF.TASK_ID)
    JOIN TB_FILE F ON(TF.FILE_ID = F.FILE_ID)
  	WHERE T.TASK_DELETE = 'N'
  	AND T.TASK_ID = #{ taskId }
	</select> 
	<!-- 	SELECT
	    	T.TASK_ID,
	    	T.MEMBER_ID,
	    	T.CLS_ID,
	    	T.TASK_TITLE,
	    	T.TASK_CONTENT,
	    	T.TASK_DATE,
	    	T.TASK_VIEW,
	    	T.TASK_DELETE,
	    	M.MEMBER_NAME
  	 FROM TB_TASK T
   	JOIN TB_MEMBER M ON (T.MEMBER_ID = M.MEMBER_ID)
  	WHERE T.TASK_DELETE = 'N'
  	AND T.TASK_ID = #{ taskId } -->
	
	<!--  과제 게시판 게시글 상세 조회 (파일) -->
	<select id="findFiles" resultMap="fileResultMap" resultType="list">
		SELECT
		    T.TASK_ID,
		    T.FILE_ID,
		    F.FILE_ORGNAME,
		    F.FILE_SAVENAME,
		    F.FILE_PATH,
		    F.FILE_TYPE
		    FROM TB_TASK_FILE T
		    JOIN TB_FILE F ON(T.FILE_ID = F.FILE_ID)
		    WHERE T.TASK_ID = #{ taskId }
	</select> 

<!--  
<select id="findDetail" resultMap="taskBoardResultMap" resultType="list">
		SELECT
	    	T.TASK_ID,
	    	T.MEMBER_ID,
	    	T.CLS_ID,
	    	T.TASK_TITLE,
	    	T.TASK_CONTENT,
	    	T.TASK_DATE,
	    	T.TASK_VIEW,
	    	M.MEMBER_NAME,
            L.FILE_ID,
            F.FILE_ORGNAME,
            F.FILE_PATH
    FROM TB_TASK T
   	JOIN TB_MEMBER M ON (T.MEMBER_ID = M.MEMBER_ID)
    LEFT JOIN TB_TASK_FILE L ON (T.TASK_ID = L.TASK_ID)
    LEFT JOIN TB_FILE F ON (L.FILE_ID = F.FILE_ID)
  	WHERE T.TASK_DELETE = 'N'
  	AND T.TASK_ID = #{ taskId }
	</select> -->

	<!-- 과제 게시판 게시글 삭제 -->
	<update id="deleteBoard">
		UPDATE 
			TB_TASK 
		SET TASK_DELETE = 'Y' 
		WHERE TASK_ID = #{ taskId }
	</update>

</mapper>